# Deploy to Dev Environment
#
# Orchestrates infrastructure, API, and web deployments to dev.
# Runs on push to main or manual trigger. Only deploys what changed
# (workflow_dispatch always deploys everything).
# CI already passed on the PR before merging to main.
#
# Required GitHub Secrets:
#   - AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID (OIDC login)
#   - SQL_ADMIN_LOGIN, SQL_ADMIN_PASSWORD (Bicep infra)
#   - AZURE_STATIC_WEB_APPS_API_TOKEN (SWA deployment token)

name: Deploy Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-dev
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # ============================================================
  # Detect which directories changed
  # ============================================================
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infra:
              - 'infra/bicep/**'
            api:
              - 'src/api/**'
            web:
              - 'src/web/**'

  # ============================================================
  # Deploy infrastructure (if Bicep files changed or manual)
  # ============================================================
  infra:
    needs: detect-changes
    if: needs.detect-changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/deploy-infra.yml
    with:
      environment: dev
    secrets: inherit

  # ============================================================
  # Deploy API (if API files changed or manual)
  # ============================================================
  api:
    needs: [detect-changes, infra]
    if: |
      !cancelled() &&
      (needs.detect-changes.outputs.api == 'true' || github.event_name == 'workflow_dispatch') &&
      (needs.infra.result == 'success' || needs.infra.result == 'skipped')
    uses: ./.github/workflows/deploy-api.yml
    with:
      environment: dev
      image-tag: ${{ github.sha }}
    secrets: inherit

  # ============================================================
  # Deploy web (if web files changed or manual)
  # ============================================================
  web:
    needs: [detect-changes, api]
    if: |
      !cancelled() &&
      (needs.detect-changes.outputs.web == 'true' || github.event_name == 'workflow_dispatch') &&
      (needs.api.result == 'success' || needs.api.result == 'skipped')
    uses: ./.github/workflows/deploy-web.yml
    with:
      environment: dev
    secrets: inherit
