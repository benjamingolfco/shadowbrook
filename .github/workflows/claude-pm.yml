name: Claude PM Agent

on:
  schedule:
    - cron: '0 6,18 * * *' # Midnight & noon CST (UTC-6)
  issues:
    types: [opened, labeled, unlabeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, synchronize]
  check_suite:
    types: [completed]

jobs:
  pm:
    # Only one PM run per issue at a time â€” newest wins, older runs are cancelled.
    # Agents post multiple comments + remove labels within seconds, each generating
    # a separate event. Without this, the PM fires 2-3 times per handback.
    concurrency:
      group: pm-${{ github.event.issue.number || github.event.pull_request.number || github.event.check_suite.id || 'cron' }}
      cancel-in-progress: true
    # All event types require the 'agentic' label except schedule (cron always runs)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && !endsWith(github.event.comment.user.login, '[bot]') && contains(github.event.issue.labels.*.name, 'agentic')) ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agentic') && !(github.event.action == 'labeled' && startsWith(github.event.label.name, 'agent/'))) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'agentic')) ||
      (github.event_name == 'check_suite' && github.event.check_suite.pull_requests[0])
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Run PM Agent
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          allowed_bots: "benjamingolfco-claude-agent[bot]"
          additional_permissions: |
            actions: read
          claude_args: |
            --model claude-sonnet-4-5-20250929 --allowedTools "Bash" "Read" "Write" "Edit" "Glob" "Grep"
          prompt: |
            Read and follow .claude/skills/agent-pipeline/SKILL.md for pipeline protocols.
            Read and follow .claude/agents/product-manager.md for your role.

            Event: ${{ github.event_name }}
            Action: ${{ github.event.action || 'N/A' }}

            Analyze the current state and take appropriate action based on your role definition.
            If this is a scheduled run, perform your cron duties (scan for stalled work, check backlog, update status comments).
            If this is a check_suite event, CI has completed. Check the result and associated PR, then act according to the CI Gate section of your role definition.
            If this is an event, respond to the specific event appropriately.
