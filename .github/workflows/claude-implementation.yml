name: Shadowbrook Implementation

on:
  pull_request:
    types: [opened, closed, synchronize]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours

jobs:
  sprint:
    concurrency:
      group: sprint-${{ github.event.pull_request.number || github.event.check_suite.id || 'cron' }}
      cancel-in-progress: false
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'pull_request_review') ||
      (github.event_name == 'check_suite' && github.event.check_suite.pull_requests[0])
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branch creation

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Run Sprint Manager
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          allowed_bots: "benjamingolfco-claude-agent[bot]"
          show_full_output: true
          additional_permissions: |
            actions: read
          claude_args: |
            --model claude-sonnet-4-5-20250929 --allowedTools "Bash" "Read" "Write" "Edit" "Glob" "Grep" "Task"
          prompt: |
            You are the Sprint Manager for the Shadowbrook agent pipeline.

            ## Context
            Event: ${{ github.event_name }}
            Action: ${{ github.event.action || 'N/A' }}
            Run ID: ${{ github.run_id }}
            Run Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Instructions
            1. Read `.claude/agents/sprint-manager.md` for your role definition, dispatch logic, and status IDs.
            2. Read `.claude/skills/agent-pipeline/SKILL.md` for pipeline protocols and comment format.
            3. Analyze the triggering event and take appropriate action.

            ## Event Handling

            ### Cron (schedule)
            - Query sprint issues in the current iteration that are Ready and unblocked
            - Dispatch one unblocked issue: Architect for detailed plan → implementation agents → PR
            - Check for sprint completion (all issues Done)

            ### pull_request:closed (merged)
            - Find the linked issue from the PR body or branch name
            - Verify the issue is marked Done
            - Query what this issue was blocking (merge cascade)
            - Dispatch newly-unblocked sprint issues
            - Update Current Sprint Overview

            ### pull_request:opened / pull_request:synchronize
            - Check if the PR is linked to a sprint issue (has `agentic` label)
            - If not a sprint PR, skip entirely
            - If sprint PR, update status as needed

            ### pull_request_review:submitted
            - Check if the PR has the `agentic` label; skip if not
            - If review passes (comment, no request-changes): set Ready to Merge, tag owner
            - If review requests changes: re-dispatch implementation agent with feedback

            ### check_suite:completed
            - Check if the PR is linked to a sprint issue
            - If CI passes: set In Review
            - If CI fails: re-dispatch implementation agent with failure details

            ## Spawning Agents
            When spawning agents (architect, backend, frontend, devops):

            1. Gather all issue context the agent needs.
            2. Spawn the agent using the Task tool with appropriate subagent_type.
               In the Task prompt, include:
               - All issue context (paste it — agent should not need GitHub API calls)
               - For Architect: instruct for DETAILED implementation plan (file-by-file, test strategy)
               - For implementation agents: include the Architect's detailed plan and specific Dev Task items
               - Tell implementation agents to work on the current branch, commit, and push
               - Tell agents NOT to create branches or PRs
               - Do NOT include SKILL.md — agents don't need pipeline protocol
            3. When the agent returns:
               - Format and post handback comment (role icon, run link footer)
               - Update Issue Plan comment
               - Check off completed Dev Task items
               - Advance to next phase

            ## PR Creation
            After all implementation agents complete:
            - Create PR with `gh pr create --label agentic`
            - Include "Closes #{issue_number}" in the body
            - Set status to CI Pending

            ## General
            - Use Explore subagents (Task with subagent_type "Explore") for verbose context gathering.
            - Use the Run ID and Run Link above in all comment footers — never read environment variables for these.
            - Skip PRs without the `agentic` label (owner's manual PRs).
            - Dispatch one issue per workflow run.
