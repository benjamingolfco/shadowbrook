name: Shadowbrook Cron

on:
  schedule:
    - cron: '0 0,6,12,18 * * *' # Every 6 hours UTC (midnight, 6am, noon, 6pm CST offset)

jobs:
  cron:
    concurrency:
      group: cron
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Run PM Cron
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}
          allowed_bots: "benjamingolfco-claude-agent[bot]"
          additional_permissions: |
            actions: read
          claude_args: |
            --model claude-opus-4-6 --allowedTools "Bash" "Read" "Write" "Edit" "Glob" "Grep" "Task"
          prompt: |
            You are the Project Manager for the Shadowbrook agent pipeline, running scheduled maintenance.

            ## Context
            Event: schedule
            Run ID: ${{ github.run_id }}
            Run Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Instructions
            1. Read `.claude/agents/project-manager.md` for your role definition, cron duties, and status IDs.
            2. Read `.claude/skills/agent-pipeline/SKILL.md` for pipeline protocols and comment format.
            3. Perform scheduled maintenance duties: standup, stalled work scan, backlog processing.

            ## Spawning Planning Agents
            When routing to a planning agent (business-analyst, architect, ux-designer) during backlog processing:

            1. Add the `agent/{name}` label for observability.
            2. Gather all issue context the agent needs (body, acceptance criteria, PM status,
               prior comments, review feedback if re-dispatch).
            3. Spawn the agent using the Task tool with subagent_type matching the agent name.
               In the Task prompt, include:
               - All issue context (paste it — agent should not need GitHub API calls)
               - Clear instructions on what to produce and return
               - Do NOT include SKILL.md — agents don't need pipeline protocol
            4. When the agent returns its work product:
               - Format it as a proper comment (role icon, run link footer per SKILL.md patterns)
               - Post the comment on the issue
               - Pin the comment if it's a Dev Task List
               - Remove the agent label
               - Update PM status comment
               - Advance to the next pipeline phase

            ## Implementation Agents
            For implementation agents (backend-developer, frontend-developer, devops):
            - Add the `agent/{name}` label. The implementation workflow handles dispatch.
            - Post a routing comment, update PM status, then finish.
            - Do NOT spawn these via Task.

            ## General
            - Use Explore subagents (Task with subagent_type "Explore") for verbose context gathering.
            - Use the Run ID and Run Link above in all comment footers — never read environment variables for these.
